<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kidney Patient QoL Estimator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hidden { display: none; }
    .phq-radio-input:checked + .phq-radio-label { background-color: #3b82f6; border-color: #2563eb; }
    .phq-radio-input:checked + .phq-radio-label::after { opacity: 1; }
    .phq-radio-label::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; border-radius: 50%; background-color: white; opacity: 0; transition: opacity 0.2s ease-in-out; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; margin-top: -8px; }
    .slider::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: none; }
    .tooltip-container { position: relative; display: inline-block; }
    .tooltip-icon { cursor: help; }
    .tooltip-text { visibility: hidden; width: max-content; max-width: 250px; background-color: #2d3748; color: #fff; text-align: center; border-radius: 0.375rem; padding: 0.5rem; position: absolute; z-index: 10; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; white-space: normal; font-size: 0.75rem; }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    .tab-button.active { border-bottom-color: #3b82f6; color: #2563eb; font-weight: 500; }
    .simulation-highlight { background-color: #f0f9ff; border: 1px solid #bae6fd; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
    .comparison-bar { background-color: #e5e7eb; border-radius: 9999px; height: 1.25rem; overflow: hidden; }
    .comparison-bar > div { height: 100%; border-radius: 9999px; transition: width 0.5s ease-out; text-align: right; padding-right: 0.5rem; color: white; font-size: 0.75rem; line-height: 1.25rem; font-weight: 500; }
    .positive-change { color: #16a34a; } .negative-change { color: #dc2626; }
    .conditional-input { transition: opacity 0.3s ease-out, max-height 0.3s ease-out; opacity: 0; max-height: 0; overflow: hidden; }
    .conditional-input.visible { opacity: 1; max-height: 500px; }
    .critical-alert { background-color: #fee2e2; border-left-width: 4px; border-color: #ef4444; color: #b91c1c; padding: 1rem; margin-top: 1rem; margin-bottom: 1rem; border-radius: 0.25rem; }
    /* Heatmap styles */
    .severity-none-bg { background-color: #f3f4f6; border-color: #e5e7eb; } 
    .severity-mild-bg { background-color: #f0fdf4; border-color: #dcfce7; }
    .severity-moderate-bg { background-color: #fefce8; border-color: #fef08a; }
    .severity-severe-bg { background-color: #fff7ed; border-color: #fed7aa; }
  </style>
</head>
<body class="bg-slate-100">
  <div class="min-h-screen flex flex-col items-center py-8 px-4">
    <div class="w-full max-w-4xl bg-white shadow-xl rounded-lg">
      <header class="bg-blue-600 text-white p-6 rounded-t-lg flex justify-between items-center">
        <h1 id="app-title" data-translate="appTitle" class="text-2xl sm:text-3xl font-bold text-center flex-grow"></h1>
        <div class="relative"><select id="language-switcher" class="bg-blue-700 text-white border border-blue-500 rounded-md py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-white"><option value="en">English</option><option value="hi">हिन्दी</option><option value="mr">मराठी</option></select></div>
      </header>

      <main class="p-2 sm:p-6">
        <div id="disclaimer-section" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded">
          <div class="flex">
            <div class="flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 text-yellow-500"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></div>
            <div class="ml-3"><p class="text-sm text-yellow-700"><strong class="font-semibold" data-translate="disclaimerTitle"></strong> <span data-translate="disclaimerText"></span></p></div>
          </div>
        </div>

        <div id="progress-tracker-section" class="px-2 sm:px-6 pb-4">
          <div class="flex items-center justify-between mb-2">
            <div id="step-indicator-1" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium">1</div>
            <div class="h-1 bg-gray-200 flex-grow mx-2 relative"><div id="progress-bar-1-2" class="bg-blue-500 h-full absolute" style="width: 0%;"></div></div>
            <div id="step-indicator-2" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium">2</div>
            <div class="h-1 bg-gray-200 flex-grow mx-2 relative"><div id="progress-bar-2-3" class="bg-blue-500 h-full absolute" style="width: 0%;"></div></div>
            <div id="step-indicator-3" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium">3</div>
            <div class="h-1 bg-gray-200 flex-grow mx-2 relative"><div id="progress-bar-3-4" class="bg-blue-500 h-full absolute" style="width: 0%;"></div></div>
            <div id="step-indicator-4" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium">4</div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <div id="step-label-1" data-translate="step1_label" class="text-center w-1/4 px-1"></div><div id="step-label-2" data-translate="step2_label" class="text-center w-1/4 px-1"></div><div id="step-label-3" data-translate="step3_label" class="text-center w-1/4 px-1"></div><div id="step-label-4" data-translate="step4_label" class="text-center w-1/4 px-1"></div>
          </div>
        </div>

        <div class="mt-6">
          <!-- Step 1-3 Containers (dynamically filled) -->
          <div id="step1-content" class="step-content"></div>
          <div id="step2-content" class="step-content hidden"></div>
          <div id="step3-content" class="step-content hidden"></div>

          <!-- Step 4: Results & Exploration (static structure) -->
          <div id="step4-content" class="step-content hidden px-2 sm:px-6 py-4 space-y-8">
            <h2 class="text-3xl font-bold text-gray-800" data-translate="step4_title"></h2>
            <div id="results-suicidal-ideation-alert" class="critical-alert hidden"></div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm text-center">
                  <h3 class="text-lg font-medium text-gray-800 mb-4" data-translate="qol_score_title"></h3>
                  <div class="relative w-48 h-24 mx-auto"><div class="h-full w-full bg-gray-100 rounded-t-full overflow-hidden"><div id="qol-gauge-fill" class="h-full transition-all duration-700 ease-out"></div></div><div class="absolute inset-0 flex flex-col items-center justify-center"><span id="qol-score-value" class="text-3xl font-bold text-gray-700"></span><span class="text-sm text-gray-500">/100</span></div></div>
                  <div id="qol-score-rating" class="mt-3 font-semibold"></div>
                  <div class="flex justify-between mt-4 text-xs text-gray-500 px-4"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div>
              </div>
              <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm text-center">
                  <h3 class="text-lg font-medium text-gray-800 mb-4" data-translate="phq_score_title"></h3>
                  <div class="relative w-full h-8 bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 rounded-full my-4"><div id="phq-marker" class="absolute top-0 -ml-2 h-8 w-4 bg-gray-800 rounded shadow"></div><div class="absolute inset-0 flex items-center justify-center"><span id="phq-score-value" class="text-xl font-bold text-white drop-shadow-md"></span><span class="text-sm text-white drop-shadow-md">/27</span></div></div>
                  <div id="phq-score-rating" class="mt-3 font-semibold"></div>
                  <div class="flex justify-between mt-4 text-xs text-gray-500"><span>0</span><span>5</span><span>10</span><span>15</span><span>20+</span></div>
              </div>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-medium text-gray-800 mb-4" data-translate="score_comparison_title"></h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 items-center gap-4 text-center sm:text-left">
                    <div class="sm:col-span-1"><div class="text-sm font-medium text-gray-700" data-translate="your_qol_score"></div><div id="comparison-your-score" class="text-2xl font-bold text-blue-600"></div></div>
                    <div class="text-gray-400 font-semibold text-lg" data-translate="vs"></div>
                    <div class="sm:col-span-1"><div class="text-sm font-medium text-gray-700"><span data-translate="avg_for"></span> <span id="comparison-modality-name"></span></div><div id="comparison-avg-score" class="text-2xl font-bold text-gray-600"></div></div>
                </div>
                <p class="text-xs text-gray-500 mt-4 text-center" data-translate="benchmark_disclaimer"></p>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-medium text-gray-800 mb-4" data-translate="key_factors_title"></h3>
                <div id="key-factors-content"></div>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                <h3 class="text-lg font-medium text-gray-800 mb-4" data-translate="explore_improvements_title"></h3>
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-1 sm:space-x-4" aria-label="Tabs">
                        <button data-tab="symptom" class="tab-button whitespace-nowrap py-3 px-1 sm:px-2 border-b-2 font-medium text-sm" data-translate="symptom_management_tab"></button>
                        <button data-tab="modality" class="tab-button whitespace-nowrap py-3 px-1 sm:px-2 border-b-2 font-medium text-sm" data-translate="modality_krt_tab"></button>
                        <button data-tab="mental" class="tab-button whitespace-nowrap py-3 px-1 sm:px-2 border-b-2 font-medium text-sm" data-translate="mental_health_tab"></button>
                    </nav>
                </div>
                <div class="pt-6">
                    <div id="symptom-tab-content" class="tab-panel hidden"></div>
                    <div id="modality-tab-content" class="tab-panel hidden"></div>
                    <div id="mental-tab-content" class="tab-panel hidden"></div>
                </div>
            </div>
          </div>
        </div>
      </main>

      <footer id="privacy-notice-section" class="p-6 border-t border-gray-200 text-xs text-gray-500 hidden">
        <h4 class="font-medium mb-1" data-translate="privacy_title"></h4>
        <p data-translate="privacy_text"></p>
      </footer>
    </div>
  </div>

  <script>
    const translations = {
        en: {
            appTitle: "Kidney Patient QoL Estimator", disclaimerTitle: "Important Disclaimer:", disclaimerText: "This tool is for educational purposes only and not a substitute for professional medical advice. Always discuss your symptoms, feelings, and treatment options with your healthcare team.",
            step1_label: "Patient Profile", step2_label: "Symptom Assessment", step3_label: "Mental Health (PHQ-9)", step4_label: "Results & Exploration",
            step1_title: "Step 1: Patient & Dialysis Profile", dialysisModality_label: "Current Dialysis Modality", distanceToFacility_label: "Distance to Hemodialysis Facility", caregiverSupport_label: "Caregiver Support at Home", timeOnCurrentModality_label: "Time on Current Modality", totalTimeOnKRT_label: "Total Time on Kidney Replacement Therapy",
            years_label: "Years", months_label: "Months", age_label: "Age (Years)", comorbidities_label: "Significant Comorbidities",
            next_symptoms: "Next: Symptom Assessment", back_button: "Back",
            step2_title: "Step 2: Symptom Assessment", step2_subtitle: "Over the past week, rate the severity of each symptom.", step2_reference: "Based on ESAS-r: Renal.",
            next_mental_health: "Next: Mental Health", step3_title: "Step 3: Mental Health (PHQ-9)", step3_subtitle: "Over the last 2 weeks, how often have you been bothered by these problems?",
            phq_problem_header: "Problem", calculate_results: "Calculate Results",
            suicidal_alert_title: "Critical Alert: Severe Depression with Suicidal Thoughts", suicidal_alert_text1: "You've indicated thoughts of self-harm while having symptoms of severe depression. It's vital to talk to someone about these feelings. Please reach out for help immediately.", suicidal_alert_helpline: "National Suicide Prevention Helpline: 1800-121-3667", suicidal_alert_text2: "The Helpline provides 24/7, free and confidential support for people in distress, prevention and crisis resources for you or your loved ones.",
            step4_title: "Your Quality of Life Assessment Results", qol_score_title: "Estimated Quality of Life Score", phq_score_title: "PHQ-9 Depression Score",
            score_comparison_title: "How Your Score Compares", your_qol_score: "Your QoL Score", vs: "vs", avg_for: "Average for", benchmark_disclaimer: "Benchmark data is illustrative and based on published research in kidney disease patients.",
            key_factors_title: "Key Factors Impacting Your Score", key_factors_intro: "The following factors from your assessment may be lowering your score:", key_factors_none: "No major factors significantly impacting your score were identified from your inputs. Continue working with your healthcare team to maintain this status.",
            symptom_burden_factor: "High Symptom Burden", phq_burden_factor: "High Mental Health Burden (PHQ-9)", comorbidity_factor: "Presence of Comorbidities", caregiver_factor_poor: "Poor Caregiver Support", distance_factor_far: "Long Distance to HD Facility",
            explore_improvements_title: "Explore Potential Improvements", symptom_management_tab: "Symptom Management", mental_health_tab: "Mental Health", modality_krt_tab: "Dialysis Modality",
            privacy_title: "Data Privacy Notice", privacy_text: "This tool processes all data locally in your browser. No personal information is transmitted or stored on any server.",
            please_select: "Please select...", select_distance: "Select distance...", select_support: "Select support level...",
            distance_close: "Close", distance_manageable: "Manageable", distance_far: "Very Far", support_good: "Good", support_average: "Average", support_poor: "Poor",
            modality_hd: "Hemodialysis", modality_pd: "Peritoneal Dialysis", modality_ckm: "Conservative Management",
            symptom_fatigue: "Fatigue / Tiredness", symptom_pain: "Pain", symptom_itching: "Itching", symptom_sleep: "Sleep Problems", symptom_cramps: "Muscle Cramps", symptom_breath: "Shortness of Breath", symptom_anxiety: "Feeling Anxious",
            severity_none: "None", severity_mild: "Mild", severity_moderate: "Moderate", severity_severe: "Severe",
            phq1_text: "Little interest or pleasure in doing things", phq2_text: "Feeling down, depressed, or hopeless", phq3_text: "Trouble sleeping or sleeping too much", phq4_text: "Feeling tired or having little energy", phq5_text: "Poor appetite or overeating", phq6_text: "Feeling bad about yourself or that you are a failure", phq7_text: "Trouble concentrating", phq8_text: "Moving/speaking slowly or being restless", phq9_text: "Thoughts of self-harm",
            phq_ans_0: "Not at all", phq_ans_1: "Several days", phq_ans_2: "More than half the days", phq_ans_3: "Nearly every day",
            comorbidity_cad: "Coronary Artery Disease", comorbidity_stroke: "Stroke", comorbidity_obesity: "Obesity", comorbidity_depression: "Depression (diagnosed)", comorbidity_malignancy: "Cancer",
            qol_rating_poor: "Poor", qol_rating_fair: "Fair", qol_rating_good: "Good", qol_rating_very_good: "Very Good", qol_rating_excellent: "Excellent",
            phq_rating_minimal: "Minimal", phq_rating_mild: "Mild", phq_rating_moderate: "Moderate", phq_rating_moderately_severe: "Moderately Severe", phq_rating_severe: "Severe",
            symptom_tab_intro: "See how managing a specific symptom might affect your quality of life.", symptom_tab_select: "Select a symptom to improve:", symptom_tab_improve_to: "Improve to:", symptom_tab_calculate: "Calculate Potential Impact", symptom_tab_no_symptoms: "No symptoms with 'Mild' or greater severity were reported. This simulation is not applicable.",
            simulation_title_symptom: "Simulation: Improving", simulation_title_modality: "Simulation: Switching to",
            baseline_score: "Baseline Score", potential_score: "Potential Score", potential_change: "Potential Change",
            modality_tab_intro: "Different dialysis modalities have different impacts on lifestyle and quality of life. This is an illustrative simulation.", modality_tab_table_header_modality: "Modality", modality_tab_table_header_simulate: "Simulate", modality_tab_simulate_btn: "Simulate Impact", modality_tab_current: "Current",
            mental_tab_intro: "Your mental well-being is a cornerstone of your quality of life. Even small improvements can have a large positive impact.", mental_tab_advice: "Based on your score, discussing these feelings with your healthcare provider or a counselor could be beneficial.", mental_tab_strategies_title: "Consider these strategies:"
        },
        hi: {
            appTitle: "गुर्दा रोगी जीवन-गुणवत्ता अनुमानक", disclaimerTitle: "महत्वपूर्ण अस्वीकरण:", disclaimerText: "यह उपकरण केवल शैक्षिक उद्देश्यों के लिए है और पेशेवर चिकित्सा सलाह का विकल्प नहीं है। अपनी स्वास्थ्य सेवा टीम से हमेशा चर्चा करें।",
            step1_label: "रोगी प्रोफ़ाइल", step2_label: "लक्षण मूल्यांकन", step3_label: "मानसिक स्वास्थ्य", step4_label: "परिणाम",
            step1_title: "चरण 1: रोगी और डायलिसिस प्रोफ़ाइल", dialysisModality_label: "वर्तमान डायलिसिस पद्धति", distanceToFacility_label: "हीमोडायलिसिस केंद्र की दूरी", caregiverSupport_label: "घर पर देखभाल करने वाले का समर्थन", timeOnCurrentModality_label: "वर्तमान पद्धति पर समय", totalTimeOnKRT_label: "कुल किडनी रिप्लेसमेंट थेरेपी पर समय",
            years_label: "वर्ष", months_label: "महीने", age_label: "आयु (वर्ष)", comorbidities_label: "महत्वपूर्ण सह-रुग्णताएँ",
            next_symptoms: "अगला: लक्षण मूल्यांकन", back_button: "वापस",
            step2_title: "चरण 2: लक्षण मूल्यांकन", step2_subtitle: "पिछले सप्ताह में, प्रत्येक लक्षण की गंभीरता का मूल्यांकन करें।", step2_reference: "ESAS-r: Renal पर आधारित।",
            next_mental_health: "अगला: मानसिक स्वास्थ्य", step3_title: "चरण 3: मानसिक स्वास्थ्य (PHQ-9)", step3_subtitle: "पिछले 2 हफ्तों में, आप इन समस्याओं से कितनी बार परेशान हुए हैं?",
            phq_problem_header: "समस्या", calculate_results: "परिणामों की गणना करें",
            suicidal_alert_title: "गंभीर चेतावनी: आत्महत्या के विचारों के साथ गंभीर अवसाद", suicidal_alert_text1: "आपने गंभीर अवसाद के लक्षणों के साथ आत्म-क्षति के विचार व्यक्त किए हैं। इन भावनाओं के बारे में किसी से बात करना बहुत महत्वपूर्ण है। कृपया तत्काल मदद के लिए संपर्क करें।", suicidal_alert_helpline: "राष्ट्रीय आत्महत्या रोकथाम हेल्पलाइन: 1800-121-3667", suicidal_alert_text2: "यह हेल्पलाइन संकट में फंसे लोगों के लिए 24/7, मुफ्त और गोपनीय सहायता, आपके और आपके प्रियजनों के लिए रोकथाम और संकट संसाधन प्रदान करती है।",
            step4_title: "आपके जीवन की गुणवत्ता के परिणाम", qol_score_title: "अनुमानित जीवन की गुणवत्ता स्कोर", phq_score_title: "अवसाद स्कोर (PHQ-9)",
            score_comparison_title: "आपके स्कोर की तुलना", your_qol_score: "आपका QoL स्कोर", vs: "बनाम", avg_for: "के लिए औसत", benchmark_disclaimer: "बेंचमार्क डेटा उदाहरणात्मक है और गुर्दा रोग के रोगियों में प्रकाशित शोध पर आधारित है।",
            key_factors_title: "आपके स्कोर को प्रभावित करने वाले मुख्य कारक", key_factors_intro: "आपके मूल्यांकन के निम्नलिखित कारक आपके स्कोर को कम कर रहे हो सकते हैं:", key_factors_none: "आपके इनपुट से आपके स्कोर को महत्वपूर्ण रूप से प्रभावित करने वाले कोई प्रमुख कारक नहीं पहचाने गए।",
            symptom_burden_factor: "उच्च लक्षण भार", phq_burden_factor: "उच्च मानसिक स्वास्थ्य भार (PHQ-9)", comorbidity_factor: "सह-रुग्णता की उपस्थिति", caregiver_factor_poor: "खराब देखभालकर्ता समर्थन", distance_factor_far: "एचडी सुविधा के लिए लंबी दूरी",
            explore_improvements_title: "संभावित सुधारों का अन्वेषण करें", symptom_management_tab: "लक्षण प्रबंधन", mental_health_tab: "मानसिक स्वास्थ्य", modality_krt_tab: "डायलिसिस पद्धति",
            privacy_title: "डेटा गोपनीयता सूचना", privacy_text: "यह टूल आपके ब्राउज़र में स्थानीय रूप से सभी डेटा को संसाधित करता है। कोई भी व्यक्तिगत जानकारी किसी भी सर्वर पर प्रेषित या संग्रहीत नहीं की जाती है।",
            please_select: "कृपया चुनें...", select_distance: "दूरी चुनें...", select_support: "समर्थन स्तर चुनें...",
            distance_close: "नज़दीक", distance_manageable: "प्रबंधनीय", distance_far: "बहुत दूर", support_good: "अच्छा", support_average: "औसत", support_poor: "खराब",
            modality_hd: "हीमोडायलिसिस", modality_pd: "पेरिटोनियल डायलिसिस", modality_ckm: "कंजर्वेटिव मैनेजमेंट",
            symptom_fatigue: "थकान / थकावट", symptom_pain: "दर्द", symptom_itching: "खुजली", symptom_sleep: "नींद की समस्या", symptom_cramps: "मांसपेशियों में ऐंठन", symptom_breath: "सांस की तकलीफ", symptom_anxiety: "चिंतित महसूस करना",
            severity_none: "कोई नहीं", severity_mild: "हल्का", severity_moderate: "मध्यम", severity_severe: "गंभीर",
            phq1_text: "चीजों को करने में कम रुचि या आनंद", phq2_text: "निराश, उदास, या हताश महसूस करना", phq3_text: "सोने में परेशानी या बहुत अधिक सोना", phq4_text: "थका हुआ महसूस करना या कम ऊर्जा होना", phq5_text: "खराब भूख या अधिक खाना", phq6_text: "अपने बारे में बुरा महसूस करना या असफल होना", phq7_text: "ध्यान केंद्रित करने में परेशानी", phq8_text: "धीरे-धीरे चलना/बोलना या बेचैन रहना", phq9_text: "आत्म-क्षति के विचार",
            phq_ans_0: "बिलकुल नहीं", phq_ans_1: "कई दिन", phq_ans_2: "आधे से ज्यादा दिन", phq_ans_3: "लगभग हर दिन",
            comorbidity_cad: "कोरोनरी धमनी रोग", comorbidity_stroke: "स्ट्रोक", comorbidity_obesity: "मोटापा", comorbidity_depression: "अवसाद (निदानित)", comorbidity_malignancy: "कैंसर",
            qol_rating_poor: "खराब", qol_rating_fair: "औसत", qol_rating_good: "अच्छा", qol_rating_very_good: "बहुत अच्छा", qol_rating_excellent: "उत्कृष्ट",
            phq_rating_minimal: "न्यूनतम", phq_rating_mild: "हल्का", phq_rating_moderate: "मध्यम", phq_rating_moderately_severe: "मध्यम रूप से गंभीर", phq_rating_severe: "गंभीर",
            symptom_tab_intro: "देखें कि किसी विशिष्ट लक्षण का प्रबंधन आपके जीवन की गुणवत्ता को कैसे प्रभावित कर सकता है।", symptom_tab_select: "सुधार के लिए एक लक्षण चुनें:", symptom_tab_improve_to: "सुधारें:", symptom_tab_calculate: "संभावित प्रभाव की गणना करें", symptom_tab_no_symptoms: "'हल्की' या अधिक गंभीरता वाले कोई लक्षण रिपोर्ट नहीं किए गए। यह सिमुलेशन लागू नहीं है।",
            simulation_title_symptom: "सिमुलेशन: सुधार", simulation_title_modality: "सिमुलेशन: में बदलना",
            baseline_score: "आधाररेखा स्कोर", potential_score: "संभावित स्कोर", potential_change: "संभावित परिवर्तन",
            modality_tab_intro: "विभिन्न डायलिसिस पद्धतियों का जीवनशैली और जीवन की गुणवत्ता पर अलग-अलग प्रभाव पड़ता है। यह एक उदाहरणात्मक सिमुलेशन है।", modality_tab_table_header_modality: "पद्धति", modality_tab_table_header_simulate: "अनुकरण करें", modality_tab_simulate_btn: "प्रभाव का अनुकरण करें", modality_tab_current: "वर्तमान",
            mental_tab_intro: "आपका मानसिक स्वास्थ्य आपके जीवन की गुणवत्ता का एक आधारशिला है। छोटे सुधारों का भी बड़ा सकारात्मक प्रभाव पड़ सकता है।", mental_tab_advice: "आपके स्कोर के आधार पर, इन भावनाओं पर अपने स्वास्थ्य सेवा प्रदाता या परामर्शदाता से चर्चा करना फायदेमंद हो सकता है।", mental_tab_strategies_title: "इन रणनीतियों पर विचार करें:"
        },
        mr: {
            appTitle: "किडनी रुग्ण जीवन गुणवत्ता अंदाजक", disclaimerTitle: "महत्त्वपूर्ण अस्वीकरण:", disclaimerText: "हे साधन केवळ शैक्षणिक उद्देशांसाठी आहे आणि व्यावसायिक वैद्यकीय सल्ल्याचा पर्याय नाही. आपल्या आरोग्य सेवा संघाशी नेहमी चर्चा करा।",
            step1_label: "रुग्ण प्रोफाइल", step2_label: "लक्षण मूल्यांकन", step3_label: "मानसिक आरोग्य", step4_label: "निकाल",
            step1_title: "पायरी 1: रुग्ण आणि डायलिसिस प्रोफाइल", dialysisModality_label: "सध्याची डायलिसिस पद्धत", distanceToFacility_label: "हीमोडायलिसिस केंद्राचे अंतर", caregiverSupport_label: "घरी काळजीवाहूचे समर्थन", timeOnCurrentModality_label: "सध्याच्या पद्धतीवरील वेळ", totalTimeOnKRT_label: "एकूण किडनी रिप्लेसमेंट थेरपीवरील वेळ",
            years_label: "वर्षे", months_label: "महिने", age_label: "वय (वर्षे)", comorbidities_label: "महत्वपूर्ण सह-आजार",
            next_symptoms: "पुढे: लक्षण मूल्यांकन", back_button: "मागे",
            step2_title: "पायरी 2: लक्षण मूल्यांकन", step2_subtitle: "गेल्या आठवड्यात, प्रत्येक लक्षणाच्या तीव्रतेचे मूल्यांकन करा.", step2_reference: "ESAS-r: Renal वर आधारित.",
            next_mental_health: "पुढे: मानसिक आरोग्य", step3_title: "पायरी 3: मानसिक आरोग्य (PHQ-9)", step3_subtitle: "गेल्या 2 आठवड्यांत, तुम्हाला या समस्यांमुळे किती वेळा त्रास झाला आहे?",
            phq_problem_header: "समस्या", calculate_results: "निकालांची गणना करा",
            suicidal_alert_title: "गंभीर सूचना: आत्महत्येच्या विचारांसह तीव्र नैराश्य", suicidal_alert_text1: "तुम्ही तीव्र नैराश्याची लक्षणे असताना आत्म-हानीचे विचार व्यक्त केले आहेत। या भावनांबद्दल कोणाशी तरी बोलणे अत्यंत महत्त्वाचे आहे। कृपया त्वरित मदतीसाठी संपर्क साधा।", suicidal_alert_helpline: "राष्ट्रीय आत्महत्या प्रतिबंध हेल्पलाइन: 1800-121-3667", suicidal_alert_text2: "ही हेल्पलाइन संकटग्रस्त लोकांसाठी 24/7, विनामूल्य आणि गोपनीय समर्थन, तुमच्यासाठी आणि तुमच्या प्रियजनांसाठी प्रतिबंध आणि संकट संसाधने प्रदान करते।",
            step4_title: "तुमच्या जीवनाच्या गुणवत्तेचे निकाल", qol_score_title: "अपेक्षित जीवनाची गुणवत्ता गुण", phq_score_title: "नैराश्य गुण (PHQ-9)",
            score_comparison_title: "तुमच्या गुणांची तुलना", your_qol_score: "तुमचा QoL गुण", vs: "विरुद्ध", avg_for: "साठी सरासरी", benchmark_disclaimer: "बेंचमार्क डेटा उदाहरणात्मक आहे आणि किडनीच्या आजाराच्या रुग्णांवरील प्रकाशित संशोधनावर आधारित आहे।",
            key_factors_title: "तुमच्या गुणांवर परिणाम करणारे मुख्य घटक", key_factors_intro: "तुमच्या मूल्यांकनातील खालील घटक तुमचे गुण कमी करत असतील:", key_factors_none: "तुमच्या इनपुटमधून तुमच्या गुणांवर लक्षणीय परिणाम करणारे कोणतेही प्रमुख घटक आढळले नाहीत।",
            symptom_burden_factor: "उच्च लक्षण भार", phq_burden_factor: "उच्च मानसिक आरोग्य भार (PHQ-9)", comorbidity_factor: "सह-आजारपणाची उपस्थिती", caregiver_factor_poor: "खराब काळजीवाहू समर्थन", distance_factor_far: "एचडी सुविधेसाठी लांब अंतर",
            explore_improvements_title: "संभाव्य सुधारणा एक्सप्लोर करा", symptom_management_tab: "लक्षण व्यवस्थापन", mental_health_tab: "मानसिक आरोग्य", modality_krt_tab: "डायलिसिस पद्धत",
            privacy_title: "डेटा गोपनीयता सूचना", privacy_text: "हे साधन तुमच्या ब्राउझरमध्ये स्थानिक पातळीवर सर्व डेटावर प्रक्रिया करते। कोणतीही वैयक्तिक माहिती कोणत्याही सर्व्हरवर प्रसारित किंवा संग्रहित केली जात नाही।",
            please_select: "कृपया निवडा...", select_distance: "अंतर निवडा...", select_support: "समर्थन पातळी निवडा...",
            distance_close: "जवळ", distance_manageable: "व्यवस्थापनीय", distance_far: "खूप दूर", support_good: "चांगले", support_average: "मध्यम", support_poor: "खराब",
            modality_hd: "हीमोडायलिसिस", modality_pd: "पेरिटोनियल डायलिसिस", modality_ckm: "कंझर्व्हेटिव्ह मॅनेजमेंट",
            symptom_fatigue: "थकवा / मरगळ", symptom_pain: "वेदना", symptom_itching: "खाज", symptom_sleep: "झोपेच्या समस्या", symptom_cramps: "स्नायू पेटके", symptom_breath: "धाप लागणे", symptom_anxiety: "चिंता वाटणे",
            severity_none: "काहीही नाही", severity_mild: "सौम्य", severity_moderate: "मध्यम", severity_severe: "तीव्र",
            phq1_text: "गोष्टी करण्यात कमी रस किंवा आनंद", phq2_text: "उदासीन, निराश किंवा हताश वाटणे", phq3_text: "झोप लागण्यात अडचण किंवा जास्त झोप येणे", phq4_text: "थकल्यासारखे वाटणे किंवा कमी ऊर्जा असणे", phq5_text: "भूक न लागणे किंवा जास्त खाणे", phq6_text: "स्वतःबद्दल वाईट वाटणे किंवा अपयशी झाल्यासारखे वाटणे", phq7_text: "गोष्टींवर लक्ष केंद्रित करण्यात अडचण", phq8_text: "हळू चालणे/बोलणे किंवा अस्वस्थ असणे", phq9_text: "आत्म-हानीचे विचार",
            phq_ans_0: "अजिबात नाही", phq_ans_1: "अनेक दिवस", phq_ans_2: "अर्ध्याहून अधिक दिवस", phq_ans_3: "जवळजवळ दररोज",
            comorbidity_cad: "कोरोनरी आर्टरी डिसीज", comorbidity_stroke: "स्ट्रोक", comorbidity_obesity: "लठ्ठपणा", comorbidity_depression: "नैराश्य (निदानित)", comorbidity_malignancy: "कर्करोग",
            qol_rating_poor: "खराब", qol_rating_fair: "मध्यम", qol_rating_good: "चांगली", qol_rating_very_good: "खूप चांगली", qol_rating_excellent: "उत्कृष्ट",
            phq_rating_minimal: "किरकोळ", phq_rating_mild: "सौम्य", phq_rating_moderate: "मध्यम", phq_rating_moderately_severe: "मध्यम-तीव्र", phq_rating_severe: "तीव्र",
            symptom_tab_intro: "एखाद्या विशिष्ट लक्षणाचे व्यवस्थापन तुमच्या जीवनाच्या गुणवत्तेवर कसा परिणाम करू शकते ते पहा.", symptom_tab_select: "सुधारण्यासाठी एक लक्षण निवडा:", symptom_tab_improve_to: "सुधारा:", symptom_tab_calculate: "संभाव्य परिणामाची गणना करा", symptom_tab_no_symptoms: "'सौम्य' किंवा त्याहून अधिक तीव्रतेची कोणतीही लक्षणे नोंदवली गेली नाहीत. हे सिम्युलेशन लागू नाही.",
            simulation_title_symptom: "सिम्युलेशन: सुधारणा", simulation_title_modality: "सिम्युलेशन: बदलणे",
            baseline_score: "आधाररेखा गुण", potential_score: "संभाव्य गुण", potential_change: "संभाव्य बदल",
            modality_tab_intro: "वेगवेगळ्या डायलिसिस पद्धतींचा जीवनशैली आणि जीवनाच्या गुणवत्तेवर वेगवेगळा परिणाम होतो. हे एक उदाहरणात्मक सिम्युलेशन आहे.", modality_tab_table_header_modality: "पद्धत", modality_tab_table_header_simulate: "अनुकरण करा", modality_tab_simulate_btn: "परिणामाचे अनुकरण करा", modality_tab_current: "सध्याचे",
            mental_tab_intro: "तुमचे मानसिक स्वास्थ्य तुमच्या जीवनाच्या गुणवत्तेचा आधारस्तंभ आहे. लहान सुधारणांचाही मोठा सकारात्मक परिणाम होऊ शकतो.", mental_tab_advice: "तुमच्या गुणांच्या आधारावर, या भावनांबद्दल तुमच्या आरोग्य सेवा प्रदात्याशी किंवा समुपदेशकाशी चर्चा करणे फायदेशीर ठरू शकते.", mental_tab_strategies_title: "या धोरणांचा विचार करा:"
        }
    };

    const SYMPTOM_OPTIONS = [ { id: 'fatigue', nameKey: 'symptom_fatigue' }, { id: 'pain', nameKey: 'symptom_pain' }, { id: 'itching', nameKey: 'symptom_itching' }, { id: 'sleep', nameKey: 'symptom_sleep' }, { id: 'cramps', nameKey: 'symptom_cramps' }, { id: 'breath', nameKey: 'symptom_breath' }, { id: 'anxiety', nameKey: 'symptom_anxiety' }];
    const SEVERITY_LEVELS = [ { id: 'none', labelKey: 'severity_none' }, { id: 'mild', labelKey: 'severity_mild' }, { id: 'moderate', labelKey: 'severity_moderate' }, { id: 'severe', labelKey: 'severity_severe' }];
    const PHQ9_QUESTIONS = [ { id: 'phq1', textKey: 'phq1_text' }, { id: 'phq2', textKey: 'phq2_text' }, { id: 'phq3', textKey: 'phq3_text' }, { id: 'phq4', textKey: 'phq4_text' }, { id: 'phq5', textKey: 'phq5_text' }, { id: 'phq6', textKey: 'phq6_text' }, { id: 'phq7', textKey: 'phq7_text' }, { id: 'phq8', textKey: 'phq8_text' }, { id: 'phq9', textKey: 'phq9_text' }];
    const PHQ9_ANSWER_OPTIONS = [ { value: 0, labelKey: 'phq_ans_0' }, { value: 1, labelKey: 'phq_ans_1' }, { value: 2, labelKey: 'phq_ans_2' }, { value: 3, labelKey: 'phq_ans_3' }];
    const COMORBIDITIES_OPTIONS = [ { id: "cad", labelKey: "comorbidity_cad" }, { id: "stroke", labelKey: "comorbidity_stroke" }, { id: "obesity", labelKey: "comorbidity_obesity" }, { id: "depression", labelKey: "comorbidity_depression" }, { id: "malignancy", labelKey: "comorbidity_malignancy" }];
    const MODALITY_DATA = { "hd-in-center": { baseQoL: 68, nameKey: "modality_hd" }, "pd": { baseQoL: 75, nameKey: "modality_pd" }, "conservative": { baseQoL: 62, nameKey: "modality_ckm" } };
    
    let currentLanguage = 'en';
    let currentStep = 1;
    let patientProfileData = {};
    let symptomAssessmentData = SYMPTOM_OPTIONS.reduce((acc, s) => ({ ...acc, [s.id]: 0 }), {});
    let phq9Data = PHQ9_QUESTIONS.map(q => ({ id: q.id, value: 0 }));
    let baselineResults = null;

    const getText = (key) => translations[currentLanguage][key] || translations.en[key];

    function updateUIText() { document.querySelectorAll('[data-translate]').forEach(el => el.textContent = getText(el.dataset.translate)); }

    function reinitializeDynamicContent() {
        document.getElementById('step1-content').innerHTML = `
            <h2 class="text-2xl font-semibold text-gray-800 mb-6" data-translate="step1_title"></h2>
            <form id="patient-profile-form" class="space-y-6">
              <div><label for="dialysisModality" class="block text-gray-700 font-medium mb-2" data-translate="dialysisModality_label"></label><select id="dialysisModality" name="dialysisModality" class="w-full p-3 border border-gray-300 rounded-lg" required></select></div>
              <div id="hd-distance-facility-section" class="conditional-input"><label for="distanceToFacility" class="block text-gray-700 font-medium mb-2" data-translate="distanceToFacility_label"></label><select id="distanceToFacility" name="distanceToFacility" class="w-full p-3 border border-gray-300 rounded-lg"></select></div>
              <div><label for="caregiverSupport" class="block text-gray-700 font-medium mb-2" data-translate="caregiverSupport_label"></label><select id="caregiverSupport" name="caregiverSupport" class="w-full p-3 border border-gray-300 rounded-lg" required></select></div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label class="block text-gray-700 font-medium mb-2" data-translate="timeOnCurrentModality_label"></label><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm" data-translate="years_label"></label><input type="number" name="currentYears" min="0" value="0" class="w-full p-3 border rounded-lg"></div><div><label class="block text-sm" data-translate="months_label"></label><input type="number" name="currentMonths" min="0" max="11" value="0" class="w-full p-3 border rounded-lg"></div></div></div>
                <div><label class="block text-gray-700 font-medium mb-2" data-translate="totalTimeOnKRT_label"></label><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm" data-translate="years_label"></label><input type="number" name="totalYears" min="0" value="0" class="w-full p-3 border rounded-lg"></div><div><label class="block text-sm" data-translate="months_label"></label><input type="number" name="totalMonths" min="0" max="11" value="0" class="w-full p-3 border rounded-lg"></div></div></div>
              </div>
              <div><label for="age" class="block text-gray-700 font-medium mb-2" data-translate="age_label"></label><input type="number" id="age" name="age" min="18" max="120" required class="w-full p-3 border border-gray-300 rounded-lg"></div>
              <div><label class="block text-gray-700 font-medium mb-2" data-translate="comorbidities_label"></label><div id="comorbidities-checkboxes" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3"></div></div>
              <div class="flex justify-end mt-8"><button type="submit" class="font-medium py-2.5 px-6 rounded-lg bg-blue-600 hover:bg-blue-700 text-white" data-translate="next_symptoms"></button></div>
            </form>`;
        document.getElementById('step2-content').innerHTML = `<h2 class="text-2xl font-semibold text-gray-800 mb-2" data-translate="step2_title"></h2><p class="text-gray-600 mb-1" data-translate="step2_subtitle"></p><p class="text-xs text-gray-500 mb-6" data-translate="step2_reference"></p><form id="symptom-assessment-form" class="space-y-6"></form><div class="flex justify-between mt-8"><button type="button" id="symptom-back-button" class="font-medium py-2.5 px-6 rounded-lg bg-gray-200 hover:bg-gray-300" data-translate="back_button"></button><button type="submit" form="symptom-assessment-form" class="font-medium py-2.5 px-6 rounded-lg bg-blue-600 hover:bg-blue-700 text-white" data-translate="next_mental_health"></button></div>`;
        document.getElementById('step3-content').innerHTML = `<h2 class="text-2xl font-semibold text-gray-800 mb-2" data-translate="step3_title"></h2><p class="text-gray-600 mb-6" data-translate="step3_subtitle"></p><form id="mental-health-form"><div class="overflow-x-auto shadow-md sm:rounded-lg border"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3 w-2/5" data-translate="phq_problem_header"></th></tr></thead><tbody id="phq9-questions-tbody"></tbody></table></div><div id="phq9-suicidal-ideation-alert" class="critical-alert hidden mt-6"><div class="flex"><div class="flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg></div><div class="ml-3"><h3 class="text-sm font-medium" data-translate="suicidal_alert_title"></h3><div class="mt-2 text-sm"><p data-translate="suicidal_alert_text1"></p><p class="mt-1 font-semibold" data-translate="suicidal_alert_helpline"></p><p class="mt-1" data-translate="suicidal_alert_text2"></p></div></div></div></div><div class="flex justify-between mt-8"><button type="button" id="phq9-back-button" class="font-medium py-2.5 px-6 rounded-lg bg-gray-200 hover:bg-gray-300" data-translate="back_button"></button><button type="submit" form="mental-health-form" class="font-medium py-2.5 px-6 rounded-lg bg-blue-600 hover:bg-blue-700 text-white" data-translate="calculate_results"></button></div></form>`;
        addEventListeners();
        populateSelects();
        populateComorbidities();
        populateSymptomSliders();
        populatePhq9Questions();
        updateUIText();
    }

    function addEventListeners() {
        document.getElementById('patient-profile-form').addEventListener('submit', e => { e.preventDefault(); patientProfileData = Object.fromEntries(new FormData(e.target).entries()); patientProfileData.comorbidities = new FormData(e.target).getAll('comorbidities'); showStep(2); });
        document.getElementById('symptom-assessment-form').addEventListener('submit', e => { e.preventDefault(); showStep(3); });
        document.getElementById('mental-health-form').addEventListener('submit', e => { e.preventDefault(); showStep(4); });
        document.getElementById('symptom-back-button').addEventListener('click', () => showStep(1));
        document.getElementById('phq9-back-button').addEventListener('click', () => showStep(2));
        document.getElementById('dialysisModality').addEventListener('change', e => { document.getElementById('hd-distance-facility-section').classList.toggle('visible', e.target.value === 'hd-in-center'); });
        document.querySelectorAll('.tab-button').forEach(b => b.addEventListener('click', () => handleTabSwitch(b.dataset.tab)));
    }

    function populateSelects() {
        const selects = {
            dialysisModality: [{ value: "", textKey: "please_select" }, { value: "hd-in-center", textKey: "modality_hd" }, { value: "pd", textKey: "modality_pd" }, { value: "conservative", textKey: "modality_ckm" }],
            distanceToFacility: [{ value: "", textKey: "select_distance" }, { value: "close", textKey: "distance_close" }, { value: "manageable", textKey: "distance_manageable" }, { value: "very-far", textKey: "distance_far" }],
            caregiverSupport: [{ value: "", textKey: "select_support", required: true }, { value: "good", textKey: "support_good" }, { value: "average", textKey: "support_average" }, { value: "poor", textKey: "support_poor" }]
        };
        for (const [id, options] of Object.entries(selects)) {
            document.getElementById(id).innerHTML = options.map(opt => `<option value="${opt.value}" ${opt.required ? 'required' : ''}>${getText(opt.textKey)}</option>`).join('');
        }
    }
    
    function populateSymptomSliders() { const formEl = document.getElementById('symptom-assessment-form'); formEl.innerHTML = ''; SYMPTOM_OPTIONS.forEach(s => { const el = document.createElement('div'); el.className="symptom-slider-container p-4 rounded-lg border transition-colors duration-300"; el.innerHTML = `<div class="flex justify-between items-center mb-2"><label class="font-medium">${getText(s.nameKey)}</label><span id="${s.id}-value-label" class="min-w-[70px] text-right font-medium"></span></div><input type="range" id="${s.id}" name="${s.id}" min="0" max="3" value="${symptomAssessmentData[s.id]}" class="slider w-full h-2 bg-gray-200 rounded-lg"><div class="flex justify-between text-xs mt-1">${SEVERITY_LEVELS.map(l => `<span>${getText(l.labelKey)}</span>`).join('')}</div>`; formEl.appendChild(el); updateSymptomSliderVisuals(s.id, symptomAssessmentData[s.id]); el.querySelector('input').addEventListener('input', e => { const val = parseInt(e.target.value); symptomAssessmentData[s.id] = val; updateSymptomSliderVisuals(s.id, val); }); }); }
    function populatePhq9Questions() { const tbody = document.getElementById('phq9-questions-tbody'); const header = document.querySelector('#mental-health-form thead tr'); tbody.innerHTML = ''; header.innerHTML = `<th scope="col" class="px-6 py-3 w-2/5">${getText('phq_problem_header')}</th>`; PHQ9_ANSWER_OPTIONS.forEach(opt => { header.innerHTML += `<th scope="col" class="px-3 py-3 text-center">${getText(opt.labelKey)}</th>`; }); PHQ9_QUESTIONS.forEach((q, i) => { const tr = document.createElement('tr'); tr.className="border-b"; tr.innerHTML = `<td class="px-6 py-4 font-medium">${i + 1}. ${getText(q.textKey)}</td>` + PHQ9_ANSWER_OPTIONS.map(opt => `<td class="px-3 py-4 text-center"><input type="radio" id="${q.id}-${opt.value}" name="${q.id}" value="${opt.value}" class="phq-radio-input sr-only" ${phq9Data[i].value === opt.value ? 'checked' : ''}><label for="${q.id}-${opt.value}" class="phq-radio-label cursor-pointer w-5 h-5 inline-flex items-center justify-center rounded-full border-2 border-gray-300"></label></td>`).join(''); tbody.appendChild(tr); tr.querySelectorAll('input').forEach(radio => radio.addEventListener('change', e => { phq9Data[i].value = parseInt(e.target.value); checkAndDisplaySuicidalIdeationAlert(); })); }); checkAndDisplaySuicidalIdeationAlert(); }
    function populateComorbidities() { document.getElementById('comorbidities-checkboxes').innerHTML = COMORBIDITIES_OPTIONS.map(c => `<div class="flex items-center"><input id="c-${c.id}" name="comorbidities" value="${c.id}" type="checkbox" class="h-4 w-4 rounded"><label for="c-${c.id}" class="ml-2 text-sm">${getText(c.labelKey)}</label></div>`).join(''); }
    
    function updateSymptomSliderVisuals(id, val) {
        const l = document.getElementById(`${id}-value-label`);
        const container = l.closest('.symptom-slider-container');
        const bgClasses = ['severity-none-bg', 'severity-mild-bg', 'severity-moderate-bg', 'severity-severe-bg'];
        container.classList.remove(...bgClasses);
        container.classList.add(bgClasses[val]);
        l.textContent = getText(SEVERITY_LEVELS[val].labelKey);
    }
    
    function checkAndDisplaySuicidalIdeationAlert() { const totalScore = phq9Data.reduce((s, q) => s + q.value, 0); const hasIdeation = phq9Data.find(q => q.id === 'phq9').value >= 1; document.getElementById('phq9-suicidal-ideation-alert').classList.toggle('hidden', !(hasIdeation && totalScore >= 20)); }
    
    function showStep(step) { currentStep = step; document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden')); document.getElementById(`step${step}-content`).classList.remove('hidden'); document.getElementById('progress-tracker-section').classList.toggle('hidden', step === 4); document.getElementById('disclaimer-section').classList.toggle('hidden', step === 4); document.getElementById('privacy-notice-section').classList.toggle('hidden', step !== 4); if (step === 4) renderResultsPage(); else updateProgressTracker(); window.scrollTo(0, 0); }
    function updateProgressTracker() { for (let i = 1; i <= 4; i++) { const ind = document.getElementById(`step-indicator-${i}`); const lbl = document.getElementById(`step-label-${i}`); ind.className = 'w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium'; lbl.className = 'text-center w-1/4 px-1 text-xs text-gray-500'; if (i < currentStep) { ind.classList.add('bg-green-500', 'text-white'); ind.innerHTML = `<svg fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`; } else if (i === currentStep) { ind.classList.add('bg-blue-500', 'text-white', 'ring-2', 'ring-offset-2'); ind.textContent = i; lbl.classList.add('font-semibold', 'text-blue-600'); } else { ind.classList.add('bg-gray-200', 'text-gray-600'); ind.textContent = i; } if (i < 4) document.getElementById(`progress-bar-${i}-${i+1}`).style.width = i < currentStep ? '100%' : '0%'; } }
    
    function calculateAllResults(profile, symptoms, phq, factorsArr) {
        let base = MODALITY_DATA[profile.dialysisModality]?.baseQoL || 68;
        let score = base;
        const addFactor = (textKey, value) => factorsArr.push({ text: getText(textKey), value });
        const symptomTotal = Object.values(symptoms).reduce((s, v) => s + v, 0);
        if (symptomTotal > 5) { score -= symptomTotal * 1.2; addFactor('symptom_burden_factor'); }
        const phqTotal = phq.reduce((s, q) => s + q.value, 0);
        if (phqTotal > 4) { score -= phqTotal * 1.5; addFactor('phq_burden_factor'); }
        const comorbidityCount = profile.comorbidities?.length || 0;
        if (comorbidityCount > 0) { score -= comorbidityCount * 2.5; addFactor('comorbidity_factor'); }
        if (profile.caregiverSupport === 'poor') { score -= 5; addFactor('caregiver_factor_poor'); }
        if (profile.distanceToFacility === 'very-far') { score -= 4; addFactor('distance_factor_far'); }
        score = Math.max(5, Math.min(99, Math.round(score)));
        let qolRatingKey, qolColor; if (score < 40) { qolRatingKey = 'qol_rating_poor'; qolColor = 'bg-red-500'; } else if (score < 60) { qolRatingKey = 'qol_rating_fair'; qolColor = 'bg-yellow-500'; } else if (score < 80) { qolRatingKey = 'qol_rating_good'; qolColor = 'bg-green-500'; } else { qolRatingKey = 'qol_rating_excellent'; qolColor = 'bg-emerald-500'; }
        let phqRatingKey; if (phqTotal < 5) phqRatingKey = 'phq_rating_minimal'; else if (phqTotal < 10) phqRatingKey = 'phq_rating_mild'; else if (phqTotal < 15) phqRatingKey = 'phq_rating_moderate'; else if (phqTotal < 20) phqRatingKey = 'phq_rating_moderately_severe'; else phqRatingKey = 'phq_rating_severe';
        return { qol: { score, rating: getText(qolRatingKey), color: qolColor }, phq: { score: phqTotal, rating: getText(phqRatingKey) }, factors: factorsArr };
    }

    function renderResultsPage() {
        const factors = [];
        baselineResults = calculateAllResults(patientProfileData, symptomAssessmentData, phq9Data, factors);
        document.getElementById('qol-score-value').textContent = baselineResults.qol.score.toFixed(1);
        document.getElementById('qol-score-rating').textContent = baselineResults.qol.rating;
        document.getElementById('qol-gauge-fill').style.width = `${baselineResults.qol.score}%`; document.getElementById('qol-gauge-fill').className = `h-full ${baselineResults.qol.color}`;
        document.getElementById('phq-score-value').textContent = baselineResults.phq.score;
        document.getElementById('phq-score-rating').textContent = baselineResults.phq.rating;
        document.getElementById('phq-marker').style.left = `${(baselineResults.phq.score / 27) * 100}%`;
        const resultsAlert = document.getElementById('results-suicidal-ideation-alert'); resultsAlert.innerHTML = document.getElementById('phq9-suicidal-ideation-alert').innerHTML; resultsAlert.classList.toggle('hidden', document.getElementById('phq9-suicidal-ideation-alert').classList.contains('hidden'));
        document.getElementById('comparison-your-score').textContent = baselineResults.qol.score.toFixed(1);
        document.getElementById('comparison-modality-name').textContent = getText(MODALITY_DATA[patientProfileData.dialysisModality].nameKey);
        document.getElementById('comparison-avg-score').textContent = MODALITY_DATA[patientProfileData.dialysisModality].baseQoL.toFixed(1);
        renderKeyFactors(factors); renderSymptomTab(); renderModalityTab(); renderMentalHealthTab();
        handleTabSwitch('symptom');
    }

    function renderKeyFactors(factors) { const container = document.getElementById('key-factors-content'); container.innerHTML = factors.length === 0 ? `<p class="text-gray-600">${getText('key_factors_none')}</p>` : `<p class="text-sm text-gray-600 mb-2">${getText('key_factors_intro')}</p><ul class="list-disc pl-5 space-y-1 text-sm">${factors.map(f => `<li>${f.text}</li>`).join('')}</ul>`; }
    function renderSymptomTab() { const container = document.getElementById('symptom-tab-content'); const improvable = SYMPTOM_OPTIONS.filter(s => symptomAssessmentData[s.id] > 0); if (improvable.length === 0) { container.innerHTML = `<p>${getText('symptom_tab_no_symptoms')}</p>`; return; } container.innerHTML = `<p class="mb-4">${getText('symptom_tab_intro')}</p><div class="grid md:grid-cols-3 gap-4 items-end"><div><label class="block text-sm font-medium mb-1">${getText('symptom_tab_select')}</label><select id="symptom-sel" class="w-full p-2 border rounded-md"><option value="">${getText('please_select')}</option>${improvable.map(s=>`<option value="${s.id}">${getText(s.nameKey)}</option>`).join('')}</select></div><div><label class="block text-sm font-medium mb-1">${getText('symptom_tab_improve_to')}</label><select id="symptom-to" class="w-full p-2 border rounded-md"></select></div><div><button id="symptom-calc" class="w-full py-2 px-4 rounded-lg bg-blue-600 text-white" disabled>${getText('symptom_tab_calculate')}</button></div></div><div id="symptom-sim-res" class="mt-4"></div>`; const selSym = document.getElementById('symptom-sel'), selTo = document.getElementById('symptom-to'), calcBtn = document.getElementById('symptom-calc'); selSym.addEventListener('change', () => { const sev = symptomAssessmentData[selSym.value]; selTo.innerHTML = SEVERITY_LEVELS.filter((l,i)=>i<sev).map((l,i)=>`<option value="${i}">${getText(l.labelKey)}</option>`).join(''); calcBtn.disabled=!selSym.value; }); calcBtn.addEventListener('click', () => { const tempSym = {...symptomAssessmentData}; tempSym[selSym.value] = parseInt(selTo.value); const newRes = calculateAllResults(patientProfileData, tempSym, phq9Data, []); document.getElementById('symptom-sim-res').innerHTML = createSimulationHTML(`${getText('simulation_title_symptom')} ${getText(SYMPTOM_OPTIONS.find(s=>s.id===selSym.value).nameKey)}`, baselineResults.qol.score, newRes.qol.score); }); }
    function renderModalityTab() { const container = document.getElementById('modality-tab-content'); container.innerHTML = `<p class="mb-4">${getText('modality_tab_intro')}</p><div class="border rounded-lg"><table class="w-full text-sm"><tbody>${Object.entries(MODALITY_DATA).map(([id, data]) => `<tr class="border-b last:border-b-0"><td class="p-3 font-medium">${getText(data.nameKey)} ${patientProfileData.dialysisModality===id?`<span class="text-xs font-normal text-blue-600">(${getText('modality_tab_current')})</span>`:''}</td><td class="p-3 text-right">${patientProfileData.dialysisModality!==id?`<button class="modality-sim-btn text-xs bg-sky-500 text-white py-1 px-2 rounded" data-id="${id}">${getText('modality_tab_simulate_btn')}</button>`:''}</td></tr>`).join('')}</tbody></table></div><div id="modality-sim-res" class="mt-4"></div>`; document.querySelectorAll('.modality-sim-btn').forEach(btn => btn.addEventListener('click', e => { const id = e.target.dataset.id; const newRes = calculateAllResults({...patientProfileData, dialysisModality:id}, symptomAssessmentData, phq9Data, []); document.getElementById('modality-sim-res').innerHTML = createSimulationHTML(`${getText('simulation_title_modality')} ${getText(MODALITY_DATA[id].nameKey)}`, baselineResults.qol.score, newRes.qol.score); })); }
    function renderMentalHealthTab() { document.getElementById('mental-tab-content').innerHTML = `<p>${getText('mental_tab_intro')}</p>${baselineResults.phq.score > 9 ? `<p class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded">${getText('mental_tab_advice')}</p>` : ''}<h4 class="font-medium mt-4 mb-2">${getText('mental_tab_strategies_title')}</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Counseling/Therapy</li><li>Support Groups</li><li>Mindfulness</li></ul>`; }
    function createSimulationHTML(title, baseline, potential) { const diff=potential-baseline; const diffText=diff>0?`+${diff.toFixed(1)}`:diff.toFixed(1); return `<div class="simulation-highlight"><h4 class="font-semibold text-lg mb-4">${title}</h4><div class="space-y-3 text-sm"><div><label class="font-medium">${getText('baseline_score')}</label><div class="comparison-bar mt-1"><div class="bg-gray-400" style="width:${baseline}%">${baseline.toFixed(1)}</div></div></div><div><label class="font-medium">${getText('potential_score')}</label><div class="comparison-bar mt-1"><div class="${potential>baseline?'bg-green-500':'bg-red-500'}" style="width:${potential}%">${potential.toFixed(1)}</div></div></div></div><p class="text-center font-bold mt-4">${getText('potential_change')}: <span class="${diff>0?'positive-change':'negative-change'} text-xl">${diffText}</span></p></div>`; }
    function handleTabSwitch(tabId) { document.querySelectorAll('.tab-button').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId)); document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('hidden', p.id !== `${tabId}-tab-content`)); }

    document.addEventListener('DOMContentLoaded', () => { document.getElementById('language-switcher').addEventListener('change', e => { currentLanguage = e.target.value; reinitializeDynamicContent(); }); reinitializeDynamicContent(); showStep(1); });
  </script>
</body>
</html>
