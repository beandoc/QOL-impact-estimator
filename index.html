<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kidney Patient QoL Estimator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hidden { display: none; }
    .phq-radio-input:checked + .phq-radio-label { background-color: #3b82f6; border-color: #2563eb; }
    .phq-radio-input:checked + .phq-radio-label::after { opacity: 1; }
    .phq-radio-label::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; border-radius: 50%; background-color: white; opacity: 0; transition: opacity 0.2s ease-in-out; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; margin-top: -8px; }
    .slider::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; border: none; }
    .tooltip-container { position: relative; display: inline-block; }
    .tooltip-icon { cursor: help; }
    .tooltip-text { visibility: hidden; width: max-content; max-width: 250px; background-color: #2d3748; color: #fff; text-align: center; border-radius: 0.375rem; padding: 0.5rem; position: absolute; z-index: 10; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; white-space: normal; font-size: 0.75rem; }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    .tab-button.active { border-bottom-color: #3b82f6; color: #2563eb; font-weight: 500; }
    .simulation-highlight { background-color: #e0f2fe; border: 1px solid #7dd3fc; padding: 0.75rem; border-radius: 0.375rem; margin-top: 0.5rem; }
    .conditional-input { transition: opacity 0.3s ease-out, max-height 0.3s ease-out; opacity: 0; max-height: 0; overflow: hidden; }
    .conditional-input.visible { opacity: 1; max-height: 500px; }
    .severity-none-bg { background-color: #f3f4f6; } .severity-mild-bg { background-color: #f0fdf4; } .severity-moderate-bg { background-color: #fefce8; } .severity-severe-bg { background-color: #fff7ed; }
    .severity-none-text { color: #4b5563; } .severity-mild-text { color: #16a34a; } .severity-moderate-text { color: #ca8a04; } .severity-severe-text { color: #ea580c; }
    .critical-alert { background-color: #fee2e2; border-left-width: 4px; border-color: #ef4444; color: #b91c1c; padding: 1rem; margin-top: 1rem; margin-bottom: 1rem; border-radius: 0.25rem; }
  </style>
</head>
<body class="bg-slate-100">
  <div class="min-h-screen flex flex-col items-center py-8 px-4">
    <div class="w-full max-w-4xl bg-white shadow-xl rounded-lg">
      <header class="bg-blue-600 text-white p-6 rounded-t-lg flex justify-between items-center">
        <h1 id="app-title" data-translate="appTitle" class="text-2xl sm:text-3xl font-bold text-center flex-grow"></h1>
        <div class="relative">
          <select id="language-switcher" class="bg-blue-700 text-white border border-blue-500 rounded-md py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-white">
            <option value="en">English</option>
            <option value="hi">हिन्दी</option>
            <option value="mr">मराठी</option>
          </select>
        </div>
      </header>

      <main class="p-2 sm:p-6">
        <!-- Disclaimer (shown on steps 1-3) -->
        <div id="disclaimer-section" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded">
          <div class="flex">
            <div class="flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 text-yellow-500"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></div>
            <div class="ml-3"><p class="text-sm text-yellow-700"><strong class="font-semibold" data-translate="disclaimerTitle"></strong> <span data-translate="disclaimerText"></span></p></div>
          </div>
        </div>

        <!-- Progress Tracker -->
        <div id="progress-tracker-section" class="px-2 sm:px-6 pb-4">
          <div class="flex items-center justify-between mb-2">
            <div id="step-indicator-1" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium">1</div>
            <div class="h-1 bg-gray-200 flex-grow mx-2 relative"><div id="progress-bar-1-2" class="bg-blue-500 h-full absolute" style="width: 0%;"></div></div>
            <div id="step-indicator-2" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium">2</div>
            <div class="h-1 bg-gray-200 flex-grow mx-2 relative"><div id="progress-bar-2-3" class="bg-blue-500 h-full absolute" style="width: 0%;"></div></div>
            <div id="step-indicator-3" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium">3</div>
            <div class="h-1 bg-gray-200 flex-grow mx-2 relative"><div id="progress-bar-3-4" class="bg-blue-500 h-full absolute" style="width: 0%;"></div></div>
            <div id="step-indicator-4" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium">4</div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <div id="step-label-1" data-translate="step1_label" class="text-center w-1/4 px-1"></div>
            <div id="step-label-2" data-translate="step2_label" class="text-center w-1/4 px-1"></div>
            <div id="step-label-3" data-translate="step3_label" class="text-center w-1/4 px-1"></div>
            <div id="step-label-4" data-translate="step4_label" class="text-center w-1/4 px-1"></div>
          </div>
        </div>

        <div class="mt-6">
          <!-- Step 1: Patient Profile -->
          <div id="step1-content" class="step-content px-2 sm:px-6 py-4">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6" data-translate="step1_title"></h2>
            <form id="patient-profile-form" class="space-y-6">
              <div>
                <label for="dialysisModality" class="block text-gray-700 font-medium mb-2"><span data-translate="dialysisModality_label"></span><span class="tooltip-container"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="ml-1 h-4 w-4 text-blue-500 inline-block tooltip-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg><span class="tooltip-text" data-translate="dialysisModality_tooltip"></span></span></label>
                <select id="dialysisModality" name="dialysisModality" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></select>
              </div>
              <div id="hd-distance-facility-section" class="conditional-input">
                <label for="distanceToFacility" class="block text-gray-700 font-medium mb-2"><span data-translate="distanceToFacility_label"></span><span class="tooltip-container"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="ml-1 h-4 w-4 text-blue-500 inline-block tooltip-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg><span class="tooltip-text" data-translate="distanceToFacility_tooltip"></span></span></label>
                <select id="distanceToFacility" name="distanceToFacility" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
              </div>
              <div>
                <label for="caregiverSupport" class="block text-gray-700 font-medium mb-2"><span data-translate="caregiverSupport_label"></span><span class="tooltip-container"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="ml-1 h-4 w-4 text-blue-500 inline-block tooltip-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg><span class="tooltip-text" data-translate="caregiverSupport_tooltip"></span></span></label>
                <select id="caregiverSupport" name="caregiverSupport" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></select>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-gray-700 font-medium mb-2"><span data-translate="timeOnCurrentModality_label"></span><span class="tooltip-container"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="ml-1 h-4 w-4 text-blue-500 inline-block tooltip-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg><span class="tooltip-text" data-translate="timeOnCurrentModality_tooltip"></span></span></label>
                  <div class="grid grid-cols-2 gap-4">
                    <div><label for="currentYears" class="block text-sm text-gray-600 mb-1" data-translate="years_label"></label><input type="number" id="currentYears" name="currentYears" min="0" max="50" value="0" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div><label for="currentMonths" class="block text-sm text-gray-600 mb-1" data-translate="months_label"></label><input type="number" id="currentMonths" name="currentMonths" min="0" max="11" value="0" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                  </div>
                </div>
                <div>
                  <label class="block text-gray-700 font-medium mb-2"><span data-translate="totalTimeOnKRT_label"></span><span class="tooltip-container"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="ml-1 h-4 w-4 text-blue-500 inline-block tooltip-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg><span class="tooltip-text" data-translate="totalTimeOnKRT_tooltip"></span></span></label>
                  <div class="grid grid-cols-2 gap-4">
                     <div><label for="totalYears" class="block text-sm text-gray-600 mb-1" data-translate="years_label"></label><input type="number" id="totalYears" name="totalYears" min="0" max="50" value="0" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div><label for="totalMonths" class="block text-sm text-gray-600 mb-1" data-translate="months_label"></label><input type="number" id="totalMonths" name="totalMonths" min="0" max="11" value="0" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                  </div>
                </div>
              </div>
              <div><label for="age" class="block text-gray-700 font-medium mb-2" data-translate="age_label"></label><input type="number" id="age" name="age" min="18" max="120" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
              <div>
                <label class="block text-gray-700 font-medium mb-2"><span data-translate="comorbidities_label"></span><span class="tooltip-container"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="ml-1 h-4 w-4 text-blue-500 inline-block tooltip-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg><span class="tooltip-text" data-translate="comorbidities_tooltip"></span></span></label>
                <div id="comorbidities-checkboxes" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3"></div>
              </div>
              <div class="flex justify-end mt-8"><button type="submit" class="font-medium py-2.5 px-6 rounded-lg bg-blue-600 hover:bg-blue-700 text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-translate="next_symptoms"></button></div>
            </form>
          </div>

          <!-- Step 2: Symptom Assessment -->
          <div id="step2-content" class="step-content hidden px-2 sm:px-6 py-4">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2" data-translate="step2_title"></h2>
            <p class="text-gray-600 mb-1" data-translate="step2_subtitle"></p>
            <p class="text-xs text-gray-500 mb-6" data-translate="step2_reference"></p>
            <form id="symptom-assessment-form" class="space-y-6"></form>
            <div class="flex justify-between mt-8">
              <button type="button" id="symptom-back-button" class="font-medium py-2.5 px-6 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400" data-translate="back_button"></button>
              <button type="submit" form="symptom-assessment-form" class="font-medium py-2.5 px-6 rounded-lg bg-blue-600 hover:bg-blue-700 text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-translate="next_mental_health"></button>
            </div>
          </div>

          <!-- Step 3: Mental Health -->
          <div id="step3-content" class="step-content hidden px-2 sm:px-6 py-4">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2" data-translate="step3_title"></h2>
            <p class="text-gray-600 mb-6" data-translate="step3_subtitle"></p>
            <form id="mental-health-form">
              <div class="overflow-x-auto shadow-md sm:rounded-lg border border-gray-200">
                <table class="w-full text-sm text-left text-gray-500">
                  <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3 w-2/5" data-translate="phq_problem_header"></th></tr></thead>
                  <tbody id="phq9-questions-tbody"></tbody>
                </table>
              </div>
              <div id="phq9-suicidal-ideation-alert" class="critical-alert hidden mt-6">
                <div class="flex">
                    <div class="flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg></div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium" data-translate="suicidal_alert_title"></h3>
                        <div class="mt-2 text-sm">
                            <p data-translate="suicidal_alert_text1"></p>
                            <p class="mt-1 font-semibold" data-translate="suicidal_alert_helpline"></p>
                            <p class="mt-1" data-translate="suicidal_alert_text2"></p>
                        </div>
                    </div>
                </div>
              </div>
              <div class="flex justify-between mt-8">
                <button type="button" id="phq9-back-button" class="font-medium py-2.5 px-6 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400" data-translate="back_button"></button>
                <button type="submit" form="mental-health-form" class="font-medium py-2.5 px-6 rounded-lg bg-blue-600 hover:bg-blue-700 text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-translate="calculate_results"></button>
              </div>
            </form>
          </div>

          <!-- Step 4: Results -->
          <div id="step4-content" class="step-content hidden px-2 sm:px-6 py-4 space-y-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2" data-translate="step4_title"></h2>
            <div id="results-suicidal-ideation-alert" class="critical-alert hidden"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm text-center">
                  <h3 class="text-lg font-medium text-gray-800 mb-4" data-translate="qol_score_title"></h3>
                  <div class="relative w-48 h-24 mx-auto"><div class="h-full w-full bg-gray-100 rounded-t-full overflow-hidden"><div id="qol-gauge-fill" class="h-full transition-all duration-700 ease-out" style="width: 0%;"></div></div><div class="absolute inset-0 flex flex-col items-center justify-center"><span id="qol-score-value" class="text-3xl font-bold text-gray-700">0.0</span><span class="text-sm text-gray-500">/100</span></div></div>
                  <div id="qol-score-rating" class="mt-3 font-semibold"></div>
                  <div class="flex justify-between mt-4 text-xs text-gray-500 px-4"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div>
              </div>
              <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm text-center">
                  <h3 class="text-lg font-medium text-gray-800 mb-4" data-translate="phq_score_title"></h3>
                  <div class="relative w-full h-8 bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 rounded-full my-4"><div id="phq-marker" class="absolute top-0 -ml-2 h-8 w-4 bg-gray-800 rounded shadow" style="left: 0%;"></div><div class="absolute inset-0 flex items-center justify-center"><span id="phq-score-value" class="text-xl font-bold text-white drop-shadow-md">0</span><span class="text-sm text-white drop-shadow-md">/27</span></div></div>
                  <div id="phq-score-rating" class="mt-3 font-semibold"></div>
                  <div class="flex justify-between mt-4 text-xs text-gray-500"><span>0</span><span>5</span><span>10</span><span>15</span><span>20+</span></div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer id="privacy-notice-section" class="p-6 border-t border-gray-200 text-xs text-gray-500 hidden">
        <h4 class="font-medium mb-1" data-translate="privacy_title"></h4>
        <p data-translate="privacy_text"></p>
      </footer>
    </div>
  </div>

  <script>
    // --- MULTILINGUAL TRANSLATIONS ---
    const translations = {
        en: {
            appTitle: "Kidney Patient QoL Estimator",
            disclaimerTitle: "Important Disclaimer:",
            disclaimerText: "This tool is for educational purposes only and not a substitute for professional medical advice. Always discuss your symptoms, feelings, and treatment options with your healthcare team.",
            step1_label: "Patient Profile", step2_label: "Symptom Assessment", step3_label: "Mental Health (PHQ-9)", step4_label: "Results & Exploration",
            step1_title: "Step 1: Patient & Dialysis Profile",
            dialysisModality_label: "Current Dialysis Modality", dialysisModality_tooltip: "The type of dialysis treatment you are receiving.",
            distanceToFacility_label: "Distance to Hemodialysis Facility", distanceToFacility_tooltip: "This impacts travel burden.",
            caregiverSupport_label: "Caregiver Support at Home", caregiverSupport_tooltip: "Support from family, friends, or paid caregivers.",
            timeOnCurrentModality_label: "Time on Current Modality", timeOnCurrentModality_tooltip: "How long you have been on your current treatment.",
            totalTimeOnKRT_label: "Total Time on Kidney Replacement Therapy", totalTimeOnKRT_tooltip: "Total time on any form of dialysis or transplant.",
            years_label: "Years", months_label: "Months", age_label: "Age (Years)",
            comorbidities_label: "Significant Comorbidities", comorbidities_tooltip: "Select any other major health conditions you have.",
            next_symptoms: "Next: Symptom Assessment", back_button: "Back",
            step2_title: "Step 2: Symptom Assessment", step2_subtitle: "Over the past week, rate the severity of each symptom.", step2_reference: "Based on ESAS-r: Renal.",
            next_mental_health: "Next: Mental Health",
            step3_title: "Step 3: Mental Health (PHQ-9)", step3_subtitle: "Over the last 2 weeks, how often have you been bothered by these problems?",
            phq_problem_header: "Problem", calculate_results: "Calculate Results",
            suicidal_alert_title: "Critical Alert: Severe Depression with Suicidal Thoughts",
            suicidal_alert_text1: "You've indicated thoughts of self-harm while having symptoms of severe depression. It's vital to talk to someone about these feelings. Please reach out for help immediately.",
            suicidal_alert_helpline: "National Suicide Prevention Helpline: 1800-121-3667",
            suicidal_alert_text2: "The Helpline provides 24/7, free and confidential support for people in distress, prevention and crisis resources for you or your loved ones.",
            step4_title: "Your Quality of Life Results", qol_score_title: "Estimated Quality of Life", phq_score_title: "Depression Score (PHQ-9)",
            privacy_title: "Data Privacy Notice", privacy_text: "All data is processed in your browser. Nothing is saved or sent to a server.",
            please_select: "Please select...", select_distance: "Select distance...", select_support: "Select support level...",
            distance_close: "Close", distance_manageable: "Manageable", distance_far: "Very Far",
            support_good: "Good", support_average: "Average", support_poor: "Poor",
            modality_hd: "Hemodialysis", modality_pd: "Peritoneal Dialysis", modality_ckm: "Conservative Management",
            symptom_fatigue: "Fatigue / Tiredness", symptom_pain: "Pain", symptom_itching: "Itching", symptom_sleep: "Sleep Problems", symptom_cramps: "Muscle Cramps", symptom_breath: "Shortness of Breath", symptom_anxiety: "Feeling Anxious",
            severity_none: "None", severity_mild: "Mild", severity_moderate: "Moderate", severity_severe: "Severe",
            phq1_text: "Little interest or pleasure in doing things", phq2_text: "Feeling down, depressed, or hopeless", phq3_text: "Trouble sleeping or sleeping too much", phq4_text: "Feeling tired or having little energy", phq5_text: "Poor appetite or overeating", phq6_text: "Feeling bad about yourself or that you are a failure", phq7_text: "Trouble concentrating", phq8_text: "Moving/speaking slowly or being restless", phq9_text: "Thoughts of self-harm",
            phq_ans_0: "Not at all", phq_ans_1: "Several days", phq_ans_2: "More than half the days", phq_ans_3: "Nearly every day",
            comorbidity_cad: "Coronary Artery Disease", comorbidity_stroke: "Stroke", comorbidity_obesity: "Obesity", comorbidity_depression: "Depression (diagnosed)", comorbidity_malignancy: "Cancer", comorbidity_infection: "Recent Infection", comorbidity_nutrition: "Poor Nutrition",
            qol_rating_poor: "Poor", qol_rating_fair: "Fair", qol_rating_good: "Good", qol_rating_very_good: "Very Good", qol_rating_excellent: "Excellent",
            phq_rating_minimal: "Minimal", phq_rating_mild: "Mild", phq_rating_moderate: "Moderate", phq_rating_moderately_severe: "Moderately Severe", phq_rating_severe: "Severe"
        },
        hi: {
            appTitle: "गुर्दा रोगी जीवन-गुणवत्ता अनुमानक",
            disclaimerTitle: "महत्वपूर्ण अस्वीकरण:",
            disclaimerText: "यह उपकरण केवल शैक्षिक उद्देश्यों के लिए है और पेशेवर चिकित्सा सलाह का विकल्प नहीं है। अपनी स्वास्थ्य सेवा टीम से हमेशा चर्चा करें।",
            step1_label: "रोगी प्रोफ़ाइल", step2_label: "लक्षण मूल्यांकन", step3_label: "मानसिक स्वास्थ्य", step4_label: "परिणाम",
            step1_title: "चरण 1: रोगी और डायलिसिस प्रोफ़ाइल",
            dialysisModality_label: "वर्तमान डायलिसिस पद्धति", dialysisModality_tooltip: "आप जिस प्रकार का डायलिसिस उपचार प्राप्त कर रहे हैं।",
            distanceToFacility_label: "हीमोडायलिसिस केंद्र की दूरी", distanceToFacility_tooltip: "यह यात्रा के बोझ को प्रभावित करता है।",
            caregiverSupport_label: "घर पर देखभाल करने वाले का समर्थन", caregiverSupport_tooltip: "परिवार, दोस्तों या भुगतान किए गए देखभाल करने वालों से समर्थन।",
            timeOnCurrentModality_label: "वर्तमान पद्धति पर समय", timeOnCurrentModality_tooltip: "आप अपने वर्तमान उपचार पर कितने समय से हैं।",
            totalTimeOnKRT_label: "कुल किडनी रिप्लेसमेंट थेरेपी पर समय", totalTimeOnKRT_tooltip: "किसी भी प्रकार के डायलिसिस या प्रत्यारोपण पर कुल समय।",
            years_label: "वर्ष", months_label: "महीने", age_label: "आयु (वर्ष)",
            comorbidities_label: "महत्वपूर्ण सह-रुग्णताएँ", comorbidities_tooltip: "किसी भी अन्य प्रमुख स्वास्थ्य स्थितियों का चयन करें।",
            next_symptoms: "अगला: लक्षण मूल्यांकन", back_button: "वापस",
            step2_title: "चरण 2: लक्षण मूल्यांकन", step2_subtitle: "पिछले सप्ताह में, प्रत्येक लक्षण की गंभीरता का मूल्यांकन करें।", step2_reference: "ESAS-r: Renal पर आधारित।",
            next_mental_health: "अगला: मानसिक स्वास्थ्य",
            step3_title: "चरण 3: मानसिक स्वास्थ्य (PHQ-9)", step3_subtitle: "पिछले 2 हफ्तों में, आप इन समस्याओं से कितनी बार परेशान हुए हैं?",
            phq_problem_header: "समस्या", calculate_results: "परिणामों की गणना करें",
            suicidal_alert_title: "गंभीर चेतावनी: आत्महत्या के विचारों के साथ गंभीर अवसाद",
            suicidal_alert_text1: "आपने गंभीर अवसाद के लक्षणों के साथ आत्म-क्षति के विचार व्यक्त किए हैं। इन भावनाओं के बारे में किसी से बात करना बहुत महत्वपूर्ण है। कृपया तत्काल मदद के लिए संपर्क करें।",
            suicidal_alert_helpline: "राष्ट्रीय आत्महत्या रोकथाम हेल्पलाइन: 1800-121-3667",
            suicidal_alert_text2: "यह हेल्पलाइन संकट में फंसे लोगों के लिए 24/7, मुफ्त और गोपनीय सहायता, आपके और आपके प्रियजनों के लिए रोकथाम और संकट संसाधन प्रदान करती है।",
            step4_title: "आपके जीवन की गुणवत्ता के परिणाम", qol_score_title: "अनुमानित जीवन की गुणवत्ता", phq_score_title: "अवसाद स्कोर (PHQ-9)",
            privacy_title: "डेटा गोपनीयता सूचना", privacy_text: "सभी डेटा आपके ब्राउज़र में संसाधित होता है। कुछ भी सहेजा या सर्वर पर नहीं भेजा जाता है।",
            please_select: "कृपया चुनें...", select_distance: "दूरी चुनें...", select_support: "समर्थन स्तर चुनें...",
            distance_close: "नज़दीक", distance_manageable: "प्रबंधनीय", distance_far: "बहुत दूर",
            support_good: "अच्छा", support_average: "औसत", support_poor: "खराब",
            modality_hd: "हीमोडायलिसिस", modality_pd: "पेरिटोनियल डायलिसिस", modality_ckm: "कंजर्वेटिव मैनेजमेंट",
            symptom_fatigue: "थकान / थकावट", symptom_pain: "दर्द", symptom_itching: "खुजली", symptom_sleep: "नींद की समस्या", symptom_cramps: "मांसपेशियों में ऐंठन", symptom_breath: "सांस की तकलीफ", symptom_anxiety: "चिंतित महसूस करना",
            severity_none: "कोई नहीं", severity_mild: "हल्का", severity_moderate: "मध्यम", severity_severe: "गंभीर",
            phq1_text: "चीजों को करने में कम रुचि या आनंद", phq2_text: "निराश, उदास, या हताश महसूस करना", phq3_text: "सोने में परेशानी या बहुत अधिक सोना", phq4_text: "थका हुआ महसूस करना या कम ऊर्जा होना", phq5_text: "खराब भूख या अधिक खाना", phq6_text: "अपने बारे में बुरा महसूस करना या असफल होना", phq7_text: "ध्यान केंद्रित करने में परेशानी", phq8_text: "धीरे-धीरे चलना/बोलना या बेचैन रहना", phq9_text: "आत्म-क्षति के विचार",
            phq_ans_0: "बिलकुल नहीं", phq_ans_1: "कई दिन", phq_ans_2: "आधे से ज्यादा दिन", phq_ans_3: "लगभग हर दिन",
            comorbidity_cad: "कोरोनरी धमनी रोग", comorbidity_stroke: "स्ट्रोक", comorbidity_obesity: "मोटापा", comorbidity_depression: "अवसाद (निदानित)", comorbidity_malignancy: "कैंसर", comorbidity_infection: "हाल का संक्रमण", comorbidity_nutrition: "खराब पोषण",
            qol_rating_poor: "खराब", qol_rating_fair: "औसत", qol_rating_good: "अच्छा", qol_rating_very_good: "बहुत अच्छा", qol_rating_excellent: "उत्कृष्ट",
            phq_rating_minimal: "न्यूनतम", phq_rating_mild: "हल्का", phq_rating_moderate: "मध्यम", phq_rating_moderately_severe: "मध्यम रूप से गंभीर", phq_rating_severe: "गंभीर"
        },
        mr: {
            appTitle: "किडनी रुग्ण जीवन गुणवत्ता अंदाजक",
            disclaimerTitle: "महत्त्वपूर्ण अस्वीकरण:",
            disclaimerText: "हे साधन केवळ शैक्षणिक उद्देशांसाठी आहे आणि व्यावसायिक वैद्यकीय सल्ल्याचा पर्याय नाही. आपल्या आरोग्य सेवा संघाशी नेहमी चर्चा करा.",
            step1_label: "रुग्ण प्रोफाइल", step2_label: "लक्षण मूल्यांकन", step3_label: "मानसिक आरोग्य", step4_label: "निकाल",
            step1_title: "पायरी 1: रुग्ण आणि डायलिसिस प्रोफाइल",
            dialysisModality_label: "सध्याची डायलिसिस पद्धत", dialysisModality_tooltip: "तुम्ही घेत असलेल्या डायलिसिस उपचाराचा प्रकार.",
            distanceToFacility_label: "हीमोडायलिसिस केंद्राचे अंतर", distanceToFacility_tooltip: "याचा प्रवासाच्या भारावर परिणाम होतो.",
            caregiverSupport_label: "घरी काळजीवाहूचे समर्थन", caregiverSupport_tooltip: "कुटुंब, मित्र किंवा पगारी काळजीवाहूंकडून मिळणारे समर्थन.",
            timeOnCurrentModality_label: "सध्याच्या पद्धतीवरील वेळ", timeOnCurrentModality_tooltip: "तुम्ही तुमच्या सध्याच्या उपचारावर किती काळापासून आहात.",
            totalTimeOnKRT_label: "एकूण किडनी रिप्लेसमेंट थेरपीवरील वेळ", totalTimeOnKRT_tooltip: "कोणत्याही प्रकारच्या डायलिसिस किंवा प्रत्यारोपणावरील एकूण वेळ.",
            years_label: "वर्षे", months_label: "महिने", age_label: "वय (वर्षे)",
            comorbidities_label: "महत्वपूर्ण सह-आजार", comorbidities_tooltip: "इतर कोणत्याही प्रमुख आरोग्य स्थिती निवडा.",
            next_symptoms: "पुढे: लक्षण मूल्यांकन", back_button: "मागे",
            step2_title: "पायरी 2: लक्षण मूल्यांकन", step2_subtitle: "गेल्या आठवड्यात, प्रत्येक लक्षणाच्या तीव्रतेचे मूल्यांकन करा.", step2_reference: "ESAS-r: Renal वर आधारित.",
            next_mental_health: "पुढे: मानसिक आरोग्य",
            step3_title: "पायरी 3: मानसिक आरोग्य (PHQ-9)", step3_subtitle: "गेल्या 2 आठवड्यांत, तुम्हाला या समस्यांमुळे किती वेळा त्रास झाला आहे?",
            phq_problem_header: "समस्या", calculate_results: "निकालांची गणना करा",
            suicidal_alert_title: "गंभीर सूचना: आत्महत्येच्या विचारांसह तीव्र नैराश्य",
            suicidal_alert_text1: "तुम्ही तीव्र नैराश्याची लक्षणे असताना आत्म-हानीचे विचार व्यक्त केले आहेत. या भावनांबद्दल कोणाशी तरी बोलणे अत्यंत महत्त्वाचे आहे. कृपया त्वरित मदतीसाठी संपर्क साधा.",
            suicidal_alert_helpline: "राष्ट्रीय आत्महत्या प्रतिबंध हेल्पलाइन: 1800-121-3667",
            suicidal_alert_text2: "ही हेल्पलाइन संकटग्रस्त लोकांसाठी 24/7, विनामूल्य आणि गोपनीय समर्थन, तुमच्यासाठी आणि तुमच्या प्रियजनांसाठी प्रतिबंध आणि संकट संसाधने प्रदान करते.",
            step4_title: "तुमच्या जीवनाच्या गुणवत्तेचे निकाल", qol_score_title: "अपेक्षित जीवनाची गुणवत्ता", phq_score_title: "नैराश्य गुण (PHQ-9)",
            privacy_title: "डेटा गोपनीयता सूचना", privacy_text: "सर्व डेटा तुमच्या ब्राउझरमध्ये प्रक्रिया केला जातो. काहीही जतन किंवा सर्व्हरवर पाठवले जात नाही.",
            please_select: "कृपया निवडा...", select_distance: "अंतर निवडा...", select_support: "समर्थन पातळी निवडा...",
            distance_close: "जवळ", distance_manageable: "व्यवस्थापनीय", distance_far: "खूप दूर",
            support_good: "चांगले", support_average: "मध्यम", support_poor: "खराब",
            modality_hd: "हीमोडायलिसिस", modality_pd: "पेरिटोनियल डायलिसिस", modality_ckm: "कंझर्व्हेटिव्ह मॅनेजमेंट",
            symptom_fatigue: "थकवा / मरगळ", symptom_pain: "वेदना", symptom_itching: "खाज", symptom_sleep: "झोपेच्या समस्या", symptom_cramps: "स्नायू पेटके", symptom_breath: "धाप लागणे", symptom_anxiety: "चिंता वाटणे",
            severity_none: "काहीही नाही", severity_mild: "सौम्य", severity_moderate: "मध्यम", severity_severe: "तीव्र",
            phq1_text: "गोष्टी करण्यात कमी रस किंवा आनंद", phq2_text: "उदासीन, निराश किंवा हताश वाटणे", phq3_text: "झोप लागण्यात किंवा झोपेत राहण्यात अडचण, किंवा जास्त झोप येणे", phq4_text: "थकल्यासारखे वाटणे किंवा कमी ऊर्जा असणे", phq5_text: "भूक न लागणे किंवा जास्त खाणे", phq6_text: "स्वतःबद्दल वाईट वाटणे किंवा अपयशी झाल्यासारखे वाटणे", phq7_text: "गोष्टींवर लक्ष केंद्रित करण्यात अडचण", phq8_text: "हळू चालणे/बोलणे किंवा अस्वस्थ असणे", phq9_text: "आत्म-हानीचे विचार",
            phq_ans_0: "अजिबात नाही", phq_ans_1: "अनेक दिवस", phq_ans_2: "अर्ध्याहून अधिक दिवस", phq_ans_3: "जवळजवळ दररोज",
            comorbidity_cad: "कोरोनरी आर्टरी डिसीज", comorbidity_stroke: "स्ट्रोक", comorbidity_obesity: "लठ्ठपणा", comorbidity_depression: "नैराश्य (निदानित)", comorbidity_malignancy: "कर्करोग", comorbidity_infection: "अलीकडील संसर्ग", comorbidity_nutrition: "अयोग्य पोषण",
            qol_rating_poor: "खराब", qol_rating_fair: "मध्यम", qol_rating_good: "चांगली", qol_rating_very_good: "खूप चांगली", qol_rating_excellent: "उत्कृष्ट",
            phq_rating_minimal: "किरकोळ", phq_rating_mild: "सौम्य", phq_rating_moderate: "मध्यम", phq_rating_moderately_severe: "मध्यम-तीव्र", phq_rating_severe: "तीव्र"
        }
    };

    // --- DATA CONSTANTS (using translation keys) ---
    const SYMPTOM_OPTIONS = [ { id: 'fatigue', nameKey: 'symptom_fatigue' }, { id: 'pain', nameKey: 'symptom_pain' }, { id: 'itching', nameKey: 'symptom_itching' }, { id: 'sleep', nameKey: 'symptom_sleep' }, { id: 'cramps', nameKey: 'symptom_cramps' }, { id: 'breath', nameKey: 'symptom_breath' }, { id: 'anxiety', nameKey: 'symptom_anxiety' }];
    const SEVERITY_LEVELS = [ { id: 'none', labelKey: 'severity_none' }, { id: 'mild', labelKey: 'severity_mild' }, { id: 'moderate', labelKey: 'severity_moderate' }, { id: 'severe', labelKey: 'severity_severe' }];
    const PHQ9_QUESTIONS = [ { id: 'phq1', textKey: 'phq1_text' }, { id: 'phq2', textKey: 'phq2_text' }, { id: 'phq3', textKey: 'phq3_text' }, { id: 'phq4', textKey: 'phq4_text' }, { id: 'phq5', textKey: 'phq5_text' }, { id: 'phq6', textKey: 'phq6_text' }, { id: 'phq7', textKey: 'phq7_text' }, { id: 'phq8', textKey: 'phq8_text' }, { id: 'phq9', textKey: 'phq9_text' }];
    const PHQ9_ANSWER_OPTIONS = [ { value: 0, labelKey: 'phq_ans_0' }, { value: 1, labelKey: 'phq_ans_1' }, { value: 2, labelKey: 'phq_ans_2' }, { value: 3, labelKey: 'phq_ans_3' }];
    const COMORBIDITIES_OPTIONS = [ { id: "cad", labelKey: "comorbidity_cad" }, { id: "stroke", labelKey: "comorbidity_stroke" }, { id: "obesity", labelKey: "comorbidity_obesity" }, { id: "depression", labelKey: "comorbidity_depression" }, { id: "malignancy", labelKey: "comorbidity_malignancy" }, { id: "infection", labelKey: "comorbidity_infection" }, { id: "nutrition", labelKey: "comorbidity_nutrition" }];

    // --- STATE VARIABLES ---
    let currentLanguage = 'en'; // Default language
    let currentStep = 1;
    let patientProfileData = {};
    let symptomAssessmentData = SYMPTOM_OPTIONS.reduce((acc, s) => ({ ...acc, [s.id]: 0 }), {});
    let phq9Data = { questions: PHQ9_QUESTIONS.map(q => ({ id: q.id, value: 0 })) };

    // --- HELPER FUNCTION ---
    const getText = (key) => translations[currentLanguage][key] || translations.en[key];

    // --- UI & LANGUAGE FUNCTIONS ---
    function updateUIText() {
        document.querySelectorAll('[data-translate]').forEach(el => {
            el.textContent = getText(el.dataset.translate);
        });
    }

    function reinitializeDynamicContent() {
        populateSelectWithOptions('dialysisModality');
        populateSelectWithOptions('distanceToFacility');
        populateSelectWithOptions('caregiverSupport');
        populateComorbidities();
        populateSymptomSliders();
        populatePhq9Questions();
    }

    function populateSelectWithOptions(type) {
        const t = translations[currentLanguage];
        let options = [];
        if (type === 'dialysisModality') options = [{ value: "", label: t.please_select }, { value: "hd-in-center", label: t.modality_hd }, { value: "pd", label: t.modality_pd }, { value: "conservative", label: t.modality_ckm }];
        else if (type === 'distanceToFacility') options = [{ value: "", label: t.select_distance }, { value: "close", label: t.distance_close }, { value: "manageable", label: t.distance_manageable }, { value: "very-far", label: t.distance_far }];
        else if (type === 'caregiverSupport') options = [{ value: "", label: t.select_support, required: true }, { value: "good", label: t.support_good }, { value: "average", label: t.support_average }, { value: "poor", label: t.support_poor }];
        
        const selectEl = document.getElementById(type);
        const currentValue = selectEl.value;
        selectEl.innerHTML = options.map(opt => `<option value="${opt.value}" ${opt.required ? 'required' : ''}>${opt.label || translations.en[opt.labelKey]}</option>`).join('');
        selectEl.value = currentValue;
    }

    // --- QUESTIONNAIRE POPULATION (GUARANTEED TO RENDER) ---
    function populateSymptomSliders() {
        const formEl = document.getElementById('symptom-assessment-form');
        formEl.innerHTML = ''; // Clear existing content
        const severityLabels = SEVERITY_LEVELS.map(level => getText(level.labelKey));
        SYMPTOM_OPTIONS.forEach(symptom => {
            const div = document.createElement('div');
            div.className = "symptom-slider-container p-4 rounded-lg shadow-sm border border-slate-200";
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-gray-700 font-medium">${getText(symptom.nameKey)} ℹ️</label>
                    <span id="${symptom.id}-value-label" class="min-w-[70px] text-right"></span>
                </div>
                <input type="range" id="${symptom.id}" name="${symptom.id}" min="0" max="3" value="${symptomAssessmentData[symptom.id]}" class="slider w-full h-2 bg-gray-200 rounded-lg">
                <div class="flex justify-between text-xs text-gray-500 mt-1 px-1">
                    ${severityLabels.map(label => `<span>${label}</span>`).join('')}
                </div>`;
            formEl.appendChild(div);
            updateSymptomSliderVisuals(symptom.id, symptomAssessmentData[symptom.id]);
            document.getElementById(symptom.id).addEventListener('input', e => {
                const value = parseInt(e.target.value);
                symptomAssessmentData[symptom.id] = value;
                updateSymptomSliderVisuals(symptom.id, value);
            });
        });
    }

    function populatePhq9Questions() {
        const tbody = document.getElementById('phq9-questions-tbody');
        const header = document.querySelector('#mental-health-form thead tr');
        tbody.innerHTML = '';
        header.innerHTML = `<th scope="col" class="px-6 py-3 w-2/5">${getText('phq_problem_header')}</th>`;
        PHQ9_ANSWER_OPTIONS.forEach(opt => {
            header.innerHTML += `<th scope="col" class="px-3 py-3 text-center whitespace-nowrap">${getText(opt.labelKey)}</th>`;
        });
        PHQ9_QUESTIONS.forEach((question, index) => {
            const tr = document.createElement('tr');
            tr.className = "bg-white border-b hover:bg-gray-50";
            const currentVal = phq9Data.questions.find(q => q.id === question.id).value;
            let radiosHtml = PHQ9_ANSWER_OPTIONS.map(opt => `
                <td class="px-3 py-4 text-center">
                    <input type="radio" id="${question.id}-${opt.value}" name="${question.id}" value="${opt.value}" class="phq-radio-input sr-only" ${currentVal === opt.value ? 'checked' : ''}>
                    <label for="${question.id}-${opt.value}" class="phq-radio-label cursor-pointer w-5 h-5 inline-flex items-center justify-center rounded-full border-2 border-gray-300"></label>
                </td>`).join('');
            tr.innerHTML = `<td class="px-6 py-4 font-medium text-gray-900">${index + 1}. ${getText(question.textKey)}</td>${radiosHtml}`;
            tbody.appendChild(tr);
            tr.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', e => {
                    phq9Data.questions.find(q => q.id === question.id).value = parseInt(e.target.value);
                    checkAndDisplaySuicidalIdeationAlert();
                });
            });
        });
        checkAndDisplaySuicidalIdeationAlert();
    }

    function populateComorbidities() {
        const container = document.getElementById('comorbidities-checkboxes');
        container.innerHTML = COMORBIDITIES_OPTIONS.map(com => `
            <div class="flex items-center">
                <input id="comorbidity-${com.id}" name="comorbidities" value="${com.id}" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="comorbidity-${com.id}" class="ml-2 block text-sm text-gray-700">${getText(com.labelKey)}</label>
            </div>`).join('');
    }

    function updateSymptomSliderVisuals(sliderId, value) {
        const severityClasses = { 0: 'severity-none-text', 1: 'severity-mild-text', 2: 'severity-moderate-text', 3: 'severity-severe-text' };
        const label = document.getElementById(`${sliderId}-value-label`);
        label.textContent = getText(SEVERITY_LEVELS[value].labelKey);
        label.className = `min-w-[70px] text-right font-medium ${severityClasses[value]}`;
    }
    
    // --- ALERT LOGIC ---
    function checkAndDisplaySuicidalIdeationAlert() {
        const totalScore = phq9Data.questions.reduce((sum, q) => sum + q.value, 0);
        const hasSuicidalIdeation = phq9Data.questions.find(q => q.id === 'phq9').value >= 1;
        const isSevereDepression = totalScore >= 20;
        document.getElementById('phq9-suicidal-ideation-alert').classList.toggle('hidden', !(hasSuicidalIdeation && isSevereDepression));
    }

    // --- NAVIGATION ---
    function showStep(step) {
        currentStep = step;
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`step${step}-content`).classList.remove('hidden');
        document.getElementById('disclaimer-section').classList.toggle('hidden', step === 4);
        document.getElementById('privacy-notice-section').classList.toggle('hidden', step !== 4);
        updateProgressTracker();
        if (step === 4) renderResultsPage();
        window.scrollTo(0, 0);
    }
    
    function updateProgressTracker() {
        for (let i = 1; i <= 4; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            const label = document.getElementById(`step-label-${i}`);
            indicator.className = 'w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium transition-colors duration-300';
            label.className = `text-center w-1/4 px-1 text-xs text-gray-500`;
            if (i < currentStep) {
                indicator.classList.add('bg-green-500', 'text-white');
                indicator.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
            } else if (i === currentStep) {
                indicator.classList.add('bg-blue-500', 'text-white', 'ring-2', 'ring-blue-500', 'ring-offset-2');
                indicator.textContent = i;
                label.classList.add('font-semibold', 'text-blue-600');
            } else {
                indicator.classList.add('bg-gray-200', 'text-gray-600');
                indicator.textContent = i;
            }
            if (i < 4) document.getElementById(`progress-bar-${i}-${i+1}`).style.width = i < currentStep ? '100%' : '0%';
        }
    }

    // --- FORM SUBMISSION & EVENT LISTENERS ---
    document.getElementById('language-switcher').addEventListener('change', e => {
        currentLanguage = e.target.value;
        updateUIText();
        reinitializeDynamicContent();
    });

    document.getElementById('patient-profile-form').addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        patientProfileData = Object.fromEntries(formData.entries());
        patientProfileData.comorbidities = formData.getAll('comorbidities');
        showStep(2);
    });

    document.getElementById('symptom-assessment-form').addEventListener('submit', e => { e.preventDefault(); showStep(3); });
    document.getElementById('mental-health-form').addEventListener('submit', e => { e.preventDefault(); showStep(4); });
    document.getElementById('symptom-back-button').addEventListener('click', () => showStep(1));
    document.getElementById('phq9-back-button').addEventListener('click', () => showStep(2));
    document.getElementById('dialysisModality').addEventListener('change', e => {
        document.getElementById('hd-distance-facility-section').classList.toggle('visible', e.target.value === 'hd-in-center');
    });

    // --- RESULTS PAGE LOGIC ---
    function renderResultsPage() {
        const { qol, phq9 } = calculateScores();
        document.getElementById('qol-gauge-fill').style.width = `${qol.score}%`;
        document.getElementById('qol-gauge-fill').className = `h-full transition-all duration-700 ease-out ${qol.colorClass}`;
        document.getElementById('qol-score-value').textContent = qol.score.toFixed(1);
        document.getElementById('qol-score-rating').textContent = qol.rating;
        
        document.getElementById('phq-marker').style.left = `${(phq9.score / 27) * 100}%`;
        document.getElementById('phq-score-value').textContent = phq9.score;
        document.getElementById('phq-score-rating').textContent = phq9.rating;
        
        const resultsAlert = document.getElementById('results-suicidal-ideation-alert');
        resultsAlert.innerHTML = document.getElementById('phq9-suicidal-ideation-alert').innerHTML;
        resultsAlert.classList.toggle('hidden', document.getElementById('phq9-suicidal-ideation-alert').classList.contains('hidden'));
    }

    function calculateScores() {
        // Simplified scoring for demonstration; a real model would be more complex
        let qolScore = 70;
        const phqTotalScore = phq9Data.questions.reduce((sum, q) => sum + q.value, 0);
        qolScore -= phqTotalScore * 1.5;
        
        const symptomTotalScore = Object.values(symptomAssessmentData).reduce((sum, val) => sum + val, 0);
        qolScore -= symptomTotalScore * 2;
        
        if (patientProfileData.caregiverSupport === 'poor') qolScore -= 5;
        if (patientProfileData.caregiverSupport === 'good') qolScore += 3;
        qolScore = Math.max(5, Math.min(99, qolScore));

        let qolRatingKey, qolColorClass;
        if (qolScore < 30) { qolRatingKey = 'qol_rating_poor'; qolColorClass = 'bg-red-500'; }
        else if (qolScore < 50) { qolRatingKey = 'qol_rating_fair'; qolColorClass = 'bg-yellow-400'; }
        else { qolRatingKey = 'qol_rating_good'; qolColorClass = 'bg-green-500'; }

        let phqRatingKey;
        if (phqTotalScore < 5) phqRatingKey = 'phq_rating_minimal';
        else if (phqTotalScore < 10) phqRatingKey = 'phq_rating_mild';
        else if (phqTotalScore < 15) phqRatingKey = 'phq_rating_moderate';
        else if (phqTotalScore < 20) phqRatingKey = 'phq_rating_moderately_severe';
        else phqRatingKey = 'phq_rating_severe';

        return {
            qol: { score: qolScore, rating: getText(qolRatingKey), colorClass: qolColorClass },
            phq9: { score: phqTotalScore, rating: getText(phqRatingKey) }
        };
    }

    // --- APP INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        currentLanguage = 'en'; // Set default language
        document.getElementById('language-switcher').value = currentLanguage;
        updateUIText();
        reinitializeDynamicContent();
        showStep(1);
    });

  </script>
</body>
</html>
